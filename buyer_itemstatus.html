<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - æ™ºè€˜äº‘é“¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "Microsoft YaHei", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            max-width: 1000px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .brand {
            font-size: 24px;
            color: #1e40af;
            font-weight: 700;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .buyer-points {
            color: #7c3aed;
            font-weight: 500;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }
        .back-index {
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        .back-index:hover {
            background: #3b82f6;
            color: white;
        }
        .item-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
            padding: 40px;
        }
        .product-base-info {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #bae6fd;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .info-label {
            color: #1e40af;
            font-weight: 500;
        }
        .info-value {
            color: #475569;
        }
        .realtime-data-title {
            font-size: 18px;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f9ff;
        }
        .realtime-data-card {
            background: #f5fafe;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #93c5fd;
        }
        .realtime-loading, .realtime-empty {
            text-align: center;
            color: #64748b;
            font-size: 16px;
            padding: 30px 0;
        }
        .realtime-error {
            text-align: center;
            color: #ef4444;
            font-size: 16px;
            padding: 30px 0;
            background: #fef2f2;
            border-radius: 8px;
        }
        .realtime-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .data-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        .data-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 10px;
        }
        .data-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e40af;
        }
        .data-unit {
            font-size: 14px;
            color: #94a3b8;
            margin-left: 5px;
        }
        .data-time {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 8px;
        }
        .buy-module {
            background: #fdf2f8;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #f9a8d4;
        }
        .buy-title {
            font-size: 18px;
            color: #be185d;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        .buy-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-item label {
            color: #831843;
            font-weight: 500;
            font-size: 14px;
        }
        .form-item input {
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        .form-item input:focus {
            outline: none;
            border-color: #db2777;
            box-shadow: 0 0 0 4px rgba(217, 70, 239, 0.1);
        }
        .buy-btn {
            padding: 14px;
            background: linear-gradient(90deg, #db2777 0%, #be185d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .buy-btn:hover {
            background: linear-gradient(90deg, #be185d 0%, #9d174d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(219, 39, 119, 0.2);
        }
        .tip {
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        .tip.error {
            color: #ef4444;
            background-color: #fef2f2;
            display: block;
        }
        .tip.success {
            color: #22c55e;
            background-color: #f0fdf4;
            display: block;
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .user-info {
                margin-top: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .item-container {
                padding: 20px;
            }
            .info-row {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">æ™ºè€˜äº‘é“¾ - å•†å“è¯¦æƒ…</div>
        <div class="user-info">
            <div class="buyer-points" id="buyerPoints">ç§¯åˆ†ï¼š0</div>
            <a href="mall.html" class="btn back-index">è¿”å›å•†åŸé¦–é¡µ</a>
        </div>
    </div>

    <div class="item-container">
        <!-- å•†å“åŸºç¡€ä¿¡æ¯ï¼ˆæ ¸å¿ƒï¼šç¡®ä¿å¿…æ˜¾ç¤ºï¼‰ -->
        <div class="product-base-info">
            <div class="info-row">
                <span class="info-label">å•†å“åç§°ï¼š</span>
                <span class="info-value" id="productName">æœªçŸ¥å•†å“</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç³»ç»Ÿå•†å“IDï¼š</span>
                <span class="info-value" id="productId">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">äº‘å¹³å°äº§å“IDï¼š</span>
                <span class="info-value" id="iotProductId">æœªé…ç½®</span>
            </div>
            <div class="info-row">
                <span class="info-label">äº‘å¹³å°è®¾å¤‡åç§°ï¼š</span>
                <span class="info-value" id="iotDeviceName">æœªé…ç½®</span>
            </div>
            <div class="info-row">
                <span class="info-label">å•†å“å•ä»·ï¼š</span>
                <span class="info-value" id="productPrice">0 å…ƒ/500g</span>
            </div>
            <div class="info-row">
                <span class="info-label">å•†å“ç§¯åˆ†ï¼š</span>
                <span class="info-value" id="productPoints">0</span>
            </div>
        </div>

        <!-- å®æ—¶ç‰©è”ç½‘æ•°æ® -->
        <div class="realtime-data-title">ğŸ“Š äº§åœ°è®¾å¤‡å®æ—¶æ•°æ®</div>
        <div class="realtime-data-card" id="realtimeDataContainer">
            <div class="realtime-loading">æ­£åœ¨è·å–è®¾å¤‡å®æ—¶æ•°æ®...</div>
        </div>

        <!-- è´­ä¹°æ¨¡å— -->
        <div class="buy-module">
            <div class="buy-title">ç«‹å³è´­ä¹°</div>
            <form class="buy-form" id="buyForm">
                <div class="form-item">
                    <label for="buyAmount">è´­ä¹°é‡é‡ï¼ˆ500g/ä»½ï¼‰</label>
                    <input type="number" id="buyAmount" placeholder="è¯·è¾“å…¥è´­ä¹°ä»½æ•°ï¼ˆæœ€å°‘1ä»½ï¼‰" min="1" value="1">
                </div>
                <div class="form-item">
                    <label for="totalPrice">æ€»ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="totalPrice" readonly placeholder="æ€»ä»·å°†è‡ªåŠ¨è®¡ç®—">
                </div>
                <button type="button" class="buy-btn" onclick="submitOrder()">ç¡®è®¤ä¸‹å•</button>
                <div class="tip" id="formTip"></div>
            </form>
        </div>
    </div>

    <script src="pointsUtils.js"></script>
    <script>
        // åˆå§‹åŒ–å˜é‡ï¼ˆå¢åŠ å®¹é”™ï¼‰
        let productId = '';
        let productPrice = 0;
        let iotProductId = '';
        let iotDeviceName = '';
        let loginUsername = localStorage.getItem('loginUsername');
        // ä½ çš„OneNET Token
        const ONENET_TOKEN = 'version=2018-10-31&res=products%2FhX3NeNcFJ4%2Fdevices%2Ftest&et=1896875804&method=md5&sign=VWh35ZxmwMwHoyR9cGwKzA%3D%3D';

        // é¡µé¢åŠ è½½åˆå§‹åŒ–ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šåˆ†æ­¥éªŒè¯ï¼Œé¿å…æå‰è·³è½¬ï¼‰
        window.onload = function() {
            // 1. éªŒè¯ç™»å½•ï¼ˆæç¤ºåä¸å¼ºåˆ¶è·³è½¬ï¼Œç¡®ä¿èƒ½æŸ¥çœ‹å•†å“çŠ¶æ€ï¼‰
            if (!loginUsername) {
                alert('è¯·å…ˆç™»å½•ï¼Œç™»å½•åå¯è´­ä¹°å•†å“ï¼');
                // æ³¨é‡Šå¼ºåˆ¶è·³è½¬ï¼Œä»…æç¤ºï¼Œç¡®ä¿èƒ½æŸ¥çœ‹å•†å“çŠ¶æ€
                // window.location.href = 'index.html';
                // return;
            }

            // 2. æ¸²æŸ“ä¹°å®¶ç§¯åˆ†ï¼ˆå®¹é”™ï¼šæœªç™»å½•ä¹Ÿæ˜¾ç¤º0ç§¯åˆ†ï¼‰
            try {
                renderBuyerPoints(loginUsername || '');
            } catch (e) {
                document.getElementById('buyerPoints').textContent = 'ç§¯åˆ†ï¼š0';
            }

            // 3. è§£æURLå‚æ•°ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¼ºåŒ–å‚æ•°è§£æï¼‰
            try {
                const params = new URLSearchParams(window.location.search);
                productId = params.get('productId') || '';
                if (!productId) {
                    alert('å•†å“IDç¼ºå¤±ï¼è¯·ä»å•†åŸé¦–é¡µç‚¹å‡»å•†å“è¿›å…¥');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (e) {
                alert('è§£æå•†å“ä¿¡æ¯å¤±è´¥ï¼');
                window.location.href = 'index.html';
                return;
            }

            // 4. æ¸²æŸ“å•†å“åŸºç¡€ä¿¡æ¯ï¼ˆå¿…æ‰§è¡Œï¼Œç¡®ä¿æ˜¾ç¤ºï¼‰
            renderProductInfo();

            // 5. è·å–å®æ—¶è®¾å¤‡æ•°æ®ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“åŸºç¡€çŠ¶æ€ï¼‰
            getRealtimeDeviceData();

            // 6. ç›‘å¬è´­ä¹°æ•°é‡å˜åŒ–
            document.getElementById('buyAmount').addEventListener('input', calculateTotalPrice);
        }

        // æ¸²æŸ“å•†å“åŸºç¡€ä¿¡æ¯ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¢åŠ å¤šå±‚å®¹é”™ï¼‰
        function renderProductInfo() {
            try {
                const sellerProducts = JSON.parse(localStorage.getItem('sellerProducts')) || [];
                const product = sellerProducts.find(item => item.id === productId);
                
                // æ‰¾åˆ°å•†å“åˆ™æ¸²æŸ“ï¼Œæ‰¾ä¸åˆ°åˆ™æç¤º
                if (product) {
                    document.getElementById('productName').textContent = product.name || 'æœªçŸ¥å•†å“';
                    document.getElementById('productId').textContent = product.id || '--';
                    document.getElementById('iotProductId').textContent = product.product_id || 'æœªé…ç½®';
                    document.getElementById('iotDeviceName').textContent = product.device_name || 'æœªé…ç½®';
                    document.getElementById('productPrice').textContent = `${product.price || 0} å…ƒ/500g`;
                    productPrice = parseFloat(product.price) || 0;
                    iotProductId = product.product_id || '';
                    iotDeviceName = product.device_name || '';
                } else {
                    document.getElementById('productName').textContent = 'å•†å“ä¸å­˜åœ¨';
                    alert('è¯¥å•†å“å·²ä¸‹æ¶æˆ–ä¸å­˜åœ¨ï¼');
                }

                // æ¸²æŸ“å•†å“ç§¯åˆ†ï¼ˆå®¹é”™ï¼‰
                try {
                    const productPoints = getProductPoints(productId) || 0;
                    document.getElementById('productPoints').textContent = productPoints;
                } catch (e) {
                    document.getElementById('productPoints').textContent = '0';
                }

                // åˆå§‹åŒ–æ€»ä»·
                calculateTotalPrice();
            } catch (e) {
                console.error('æ¸²æŸ“å•†å“ä¿¡æ¯å¤±è´¥ï¼š', e);
                alert('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–å®æ—¶è®¾å¤‡æ•°æ®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šæ¥å£å¤±è´¥ä¹Ÿæ˜¾ç¤ºåŸºç¡€æç¤ºï¼‰
        async function getRealtimeDeviceData() {
            const container = document.getElementById('realtimeDataContainer');
            
            // æ— ç‰©è”ç½‘é…ç½®
            if (!iotProductId || !iotDeviceName) {
                container.innerHTML = `
                    <div class="realtime-empty">
                        è¯¥å•†å“æš‚æœªå…³è”ç‰©è”ç½‘è®¾å¤‡ï¼Œæ— å®æ—¶æ•°æ®
                    </div>
                `;
                return;
            }

            try {
                // çœŸå®OneNETæ¥å£è¯·æ±‚
                const apiUrl = `https://iot-api.heclouds.com/thingmodel/query-device-property?product_id=${iotProductId}&device_name=${iotDeviceName}`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Authorization': ONENET_TOKEN
                    }
                });

                if (!response.ok) throw new Error(`æ¥å£è¿”å›å¼‚å¸¸ï¼š${response.status}`);
                const result = await response.json();

                if (result.code !== 0) {
                    container.innerHTML = `<div class="realtime-error">è·å–å®æ—¶æ•°æ®å¤±è´¥ï¼š${result.msg || 'æ¥å£è¿”å›å¼‚å¸¸'}</div>`;
                    return;
                }

                const validData = result.data.filter(item => item.value !== undefined && item.value !== null);
                
                if (validData.length === 0) {
                    container.innerHTML = `<div class="realtime-empty">æš‚æ— è®¾å¤‡å®æ—¶æ•°æ®</div>`;
                    return;
                }

                // æ¸²æŸ“å®æ—¶æ•°æ®
                let html = '<div class="realtime-data-grid">';
                validData.forEach(item => {
                    const updateTime = item.time ? new Date(item.time).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                    let unit = '';
                    if (item.identifier === 'temp') unit = 'â„ƒ';
                    if (item.identifier === 'humi' || item.identifier === 'shum') unit = '%';
                    if (item.identifier === 'co2') unit = 'ppm';

                    html += `
                        <div class="data-item">
                            <div class="data-label">${item.name}</div>
                            <div class="data-value">${item.value}<span class="data-unit">${unit}</span></div>
                            <div class="data-time">æ›´æ–°æ—¶é—´ï¼š${updateTime}</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                // æ¥å£è°ƒç”¨å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤ºï¼ˆä¸å½±å“å•†å“åŸºç¡€çŠ¶æ€ï¼‰
                console.error('å®æ—¶æ•°æ®æ¥å£è°ƒç”¨å¤±è´¥ï¼š', error);
                container.innerHTML = `
                    <div class="realtime-error">
                        å®æ—¶æ•°æ®è·å–å¤±è´¥ï¼ˆç½‘ç»œ/æ¥å£é—®é¢˜ï¼‰<br>
                        å•†å“åŸºç¡€çŠ¶æ€ä¸å—å½±å“
                    </div>
                `;
            }
        }

        // è®¡ç®—æ€»ä»·ï¼ˆå®¹é”™ï¼‰
        function calculateTotalPrice() {
            try {
                const buyAmount = parseInt(document.getElementById('buyAmount').value) || 1;
                const totalPrice = (buyAmount * productPrice).toFixed(2);
                document.getElementById('totalPrice').value = totalPrice;
            } catch (e) {
                document.getElementById('totalPrice').value = '0.00';
            }
        }

        // æäº¤è®¢å•ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œå¢åŠ å®¹é”™ï¼‰
        function submitOrder() {
            // æœªç™»å½•åˆ™æç¤ºç™»å½•
            if (!loginUsername) {
                alert('è¯·å…ˆç™»å½•åä¸‹å•ï¼');
                window.location.href = 'login.html';
                return;
            }

            const tip = document.getElementById('formTip');
            let buyAmount, totalPrice;
            try {
                buyAmount = parseInt(document.getElementById('buyAmount').value) || 1;
                totalPrice = parseFloat(document.getElementById('totalPrice').value) || 0;
            } catch (e) {
                tip.className = 'tip error';
                tip.textContent = 'å‚æ•°è§£æå¤±è´¥ï¼';
                return;
            }

            // éªŒè¯
            if (buyAmount < 1) {
                tip.className = 'tip error';
                tip.textContent = 'è´­ä¹°ä»½æ•°ä¸èƒ½å°‘äº1ä»½ï¼';
                return;
            }
            if (totalPrice <= 0) {
                tip.className = 'tip error';
                tip.textContent = 'è®¢å•é‡‘é¢å¼‚å¸¸ï¼';
                return;
            }

            // ç”Ÿæˆè®¢å•
            try {
                const orderId = 'ORD' + Date.now();
                const newOrder = {
                    orderId: orderId,
                    productId: productId,
                    productName: document.getElementById('productName').textContent,
                    buyerName: loginUsername,
                    amount: buyAmount,
                    totalPrice: totalPrice,
                    createTime: new Date().toLocaleString(),
                    payStatus: 'å·²æ”¯ä»˜'
                };

                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));

                // å¢åŠ ç§¯åˆ†ï¼ˆå®¹é”™ï¼‰
                const addPoints = Math.floor(totalPrice * 10);
                let newPoints = 0;
                try {
                    newPoints = addBuyerPoints(loginUsername, totalPrice);
                    recordOrderPoints(orderId, productId, loginUsername, addPoints);
                    addProductPoints(productId, totalPrice);
                } catch (e) {
                    console.error('ç§¯åˆ†è®¡ç®—å¤±è´¥ï¼š', e);
                }

                // æç¤ºæˆåŠŸ
                tip.className = 'tip success';
                tip.textContent = `ä¸‹å•æˆåŠŸï¼
è®¢å•IDï¼š${orderId}
è´­ä¹°ä»½æ•°ï¼š${buyAmount} ä»½
è®¢å•é‡‘é¢ï¼š${totalPrice} å…ƒ
è·å¾—ç§¯åˆ†ï¼š+${addPoints}
å½“å‰ç§¯åˆ†ï¼š${newPoints}`;

                // ç¦ç”¨æŒ‰é’®
                document.querySelector('.buy-btn').disabled = true;
                document.querySelector('.buy-btn').textContent = 'ä¸‹å•æˆåŠŸ';

                // 3ç§’åè¿”å›é¦–é¡µ
                setTimeout(() => {
                    window.location.href = 'mall.html';
                }, 3000);
            } catch (e) {
                tip.className = 'tip error';
                tip.textContent = 'ä¸‹å•å¤±è´¥ï¼š' + e.message;
            }
        }
    </script>
</body>
</html>